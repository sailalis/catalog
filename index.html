<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Parts Catalog</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#f5f5f5;color:#0f172a;overflow:hidden}

  /* Banner */
  .banner{position:fixed;top:0;left:0;right:0;z-index:100;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.15)}
  .bar{display:grid;grid-template-columns:1fr;gap:10px;padding:12px 14px}
  .bar h1{font-size:18px;font-weight:700;letter-spacing:.2px}
  .search{
    padding:10px 12px;border:none;border-radius:8px;font-size:15px;background:#fff;
    box-shadow:0 2px 4px rgba(0,0,0,.1);max-width:100%;
    justify-self:start; /* prevent grid stretch */
  }
  .search:focus{outline:none;box-shadow:0 4px 8px rgba(0,0,0,.15)}
  .filters{display:flex;gap:8px;flex-wrap:wrap}
  .fbtn{padding:6px 12px;border:2px solid rgba(255,255,255,.55);border-radius:18px;background:transparent;color:#fff;font-size:13px;cursor:pointer}
  .fbtn.active{background:#fff;color:#667eea;border-color:#fff}
  .stats{font-size:12px;opacity:.95}

  /* Table area flush under banner */
  .wrap{position:fixed;left:0;right:0;bottom:0;background:#fff;overflow:hidden}

  /* Header + body */
  .thead{position:sticky;top:0;background:#f8f9fa;border-bottom:2px solid #dee2e6;z-index:10;overflow:hidden}
  .thead table,#bodyTable{width:max-content;border-collapse:collapse;table-layout:auto}
  .thead th{padding:10px 12px;text-align:left;font-weight:700;white-space:nowrap;font-size:12px;text-transform:uppercase;color:#475569;border:none}

  .container{
    height:100%;
    overflow-y:auto;   /* vertical only */
    overflow-x:hidden; /* lock horizontal to stop jiggle */
    position:relative;
    touch-action:pan-y;
    overscroll-behavior-x:none;
  }
  .tbody{position:absolute;top:0;left:0}
  .spacer{width:100%}
  .tbody td{padding:10px 12px;border-bottom:1px solid #e9ecef;vertical-align:middle;white-space:nowrap}
  .tbody tr.row-a{background:#ffffff}
  .tbody tr.row-b{background:#f6f7fb}
  .tbody tr:hover{background:#eef2ff}
  .nores,.loading{text-align:center;padding:28px;color:#64748b}

  /* Cells */
  .nom{white-space:normal}
  .nom a{color:#133370;text-decoration:underline}
  .nom a:visited{color:#133370}
  .nom a:hover{color:#136270;text-decoration:underline}
  .nom .nom-wrap{
    max-width:28ch;         /* conservative width; wraps only if needed */
    overflow:hidden;
    display:-webkit-box;
    -webkit-line-clamp:2;   /* fixed height for virtualization */
    -webkit-box-orient:vertical;
  }
  .pn{display:grid;grid-template-columns:auto 1fr;column-gap:6px;row-gap:3px}
  .pn .tag{font-size:11px;color:#64748b;white-space:nowrap}
  .pn .val{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis} /* never wrap part numbers */

  /* Popover */
  .pop{position:fixed;min-width:220px;max-width:300px;background:#fff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:12px;z-index:1000}
  .pop h4{font-size:13px;margin-bottom:8px;color:#334155}
  .kv{display:flex;justify-content:space-between;gap:8px;font-size:13px;padding:6px 0;border-bottom:1px dashed #e2e8f0}
  .kv:last-child{border-bottom:none}
  .k{color:#64748b}
  .v{font-weight:600}
  .x{position:absolute;top:6px;right:8px;border:none;background:transparent;font-size:18px;cursor:pointer;color:#64748b}

  @media (max-width:768px){
    .bar{gap:8px;padding:10px 12px}
    .bar h1{font-size:16px}
    .thead th,.tbody td{padding:8px 8px;font-size:12px}
    .nom .nom-wrap{max-width:24ch}
  }
</style>
</head>
<body>
  <!-- Banner -->
  <div id="banner" class="banner">
    <div class="bar">
      <h1>Parts Catalog</h1>
      <input id="q" class="search" placeholder="Search NOMENCLATURE, JSF PART NUMBER, MFR PART NUMBER"/>
      <div class="filters">
        <button class="fbtn" data-filter="EEL">EEL: Yes</button>
        <button class="fbtn" data-filter="SERIAL">SERIAL: Yes</button>
        <button class="fbtn" data-filter="TURN-IN">TURN-IN: Yes</button>
      </div>
      <div id="stats" class="stats">Loading…</div>
    </div>
  </div>

  <!-- Table area -->
  <div id="wrap" class="wrap">
    <div class="thead">
      <table id="hdrTable">
        <colgroup id="cgHead"></colgroup>
        <thead><tr id="hdr"></tr></thead>
      </table>
    </div>
    <div id="cont" class="container">
      <div class="loading">Loading parts catalog…</div>
    </div>
  </div>

  <!-- Popover -->
  <div id="pop" class="pop" style="display:none"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    // CONFIG
    const CSV_URL = 'https://raw.githubusercontent.com/sailalis/catalog/refs/heads/main/datatest.csv';

    // Visible: NOMENCLATURE (clickable) | PART NUMBER (stacked)
    const COLS = [
      { label: 'NOMENCLATURE', key: 'NOMENCLATURE' },
      { label: 'PART NUMBER',  key: '_PARTNUM_' }, // JSF + MFR
    ];

    // Hidden in popover
    const HIDDEN_KEYS = ['SMR','EEL','TURN-IN','SERIAL'];

    // Virtual rows
    const ROW_H = 68, BUFFER = 10, DEBOUNCE_MS = 90;

    // STATE
    let rows = [], rowsById = new Map(), filtered = [];
    let lastStart = -1, lastEnd = -1;

    // DOM
    const banner = document.getElementById('banner');
    const wrap = document.getElementById('wrap');
    const q = document.getElementById('q');
    const stats = document.getElementById('stats');
    const cont = document.getElementById('cont');
    const hdr = document.getElementById('hdr');
    const cgHead = document.getElementById('cgHead');
    const hdrTable = document.getElementById('hdrTable');
    const pop = document.getElementById('pop');

    // Header
    hdr.innerHTML = COLS.map(c=>`<th>${c.label}</th>`).join('');

    // Flush table under banner
    function placeTable(){
      wrap.style.top = banner.getBoundingClientRect().height + 'px';
    }
    placeTable();

    window.addEventListener('resize', () => {
      placeTable();
      computeAndSetColWidths();
      setSearchWidth();
      render(false);
    });

    // Load CSV
    Papa.parse(CSV_URL, {
      download:true, header:true, skipEmptyLines:true,
      complete: ({data}) => {
        rows = data.map((r,i)=>{
          const needle = [r['NOMENCLATURE']||'', r['JSF PART NUMBER']||'', r['MFR PART NUMBER']||'']
            .join(' ').toLowerCase();
          const row = {...r, _id:i, _needle:needle};
          rowsById.set(i,row);
          return row;
        });
        filtered = rows;
        stats.textContent = `Showing ${fmt(filtered.length)} of ${fmt(rows.length)} parts`;

        computeAndSetColWidths();
        setSearchWidth();
        cont.innerHTML = '';
        render(true);
      },
      error: ()=>{ cont.innerHTML = '<div class="nores">Error loading catalog.</div>'; }
    });

    // Measure text width
    function meas(str, font='14px -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, sans-serif'){
      const c = meas.canvas || (meas.canvas = document.createElement('canvas'));
      const ctx = c.getContext('2d');
      ctx.font = font;
      return Math.ceil(ctx.measureText(str).width);
    }

    // Compute snug widths within viewport
    function computeAndSetColWidths(){
      const pad = 24;
      const isMobile = window.innerWidth <= 768;
      const avail = Math.max(240, (wrap.clientWidth || window.innerWidth) - 1);

      let pnMax = meas('PART NUMBER');
      for (const r of rows){
        pnMax = Math.max(pnMax, meas(`JSF: ${(r['JSF PART NUMBER']||'').toString().trim()}`));
        pnMax = Math.max(pnMax, meas(`MFR: ${(r['MFR PART NUMBER']||'').toString().trim()}`));
      }
      let PN_W = pnMax + pad;
      const PN_MIN = 160;
      const PN_CAP = isMobile ? Math.floor(avail * 0.58) : Math.min(520, Math.floor(avail * 0.55));
      PN_W = Math.max(PN_MIN, Math.min(PN_W, PN_CAP));

      const NOM_MIN = isMobile ? 200 : 240;
      let NOM_W = Math.max(NOM_MIN, avail - PN_W);

      cgHead.innerHTML = `
        <col style="width:${NOM_W}px">
        <col style="width:${PN_W}px">
      `;

      computeAndSetColWidths.NOM_W = NOM_W;
      computeAndSetColWidths.PN_W  = PN_W;
      computeAndSetColWidths.AVAIL = avail;
    }

    // Search width ≈ NOM width + 40px (slightly wider than NOM), capped to viewport
    function setSearchWidth(){
      const nom = computeAndSetColWidths.NOM_W || 280;
      const avail = computeAndSetColWidths.AVAIL || (wrap.clientWidth || window.innerWidth);
      const w = Math.min(nom + 40, avail);
      q.style.width = Math.max(220, w) + 'px';
    }

    // Filters
    const activeFilters = new Set();
    document.querySelectorAll('.fbtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const k = btn.dataset.filter;
        if (activeFilters.has(k)) { activeFilters.delete(k); btn.classList.remove('active'); }
        else { activeFilters.add(k); btn.classList.add('active'); }
        runFilter();
      });
    });

    // Search
    q.addEventListener('input', debounce(runFilter, DEBOUNCE_MS));

    function runFilter(){
      const term = q.value.trim().toLowerCase();
      filtered = rows.filter(r=>{
        if (term && !r._needle.includes(term)) return false;
        for (const f of activeFilters){
          const v = (r[f]||'').toString().toLowerCase();
          if (v !== 'yes') return false;
        }
        return true;
      });
      cont.scrollTop = 0;
      cont.scrollLeft = 0;
      hdrTable.style.transform = 'translateX(0px)';
      lastStart = -1; lastEnd = -1;
      stats.textContent = `Showing ${fmt(filtered.length)} of ${fmt(rows.length)} parts`;
      render(true);
      hidePop();
    }

    // Vertical scroll virtualization; kill any accidental horizontal drift
    cont.addEventListener('scroll', ()=>{
      if (cont.scrollLeft !== 0){
        cont.scrollLeft = 0;
        hdrTable.style.transform = 'translateX(0px)';
      }
      requestAnimationFrame(()=>{ render(false); hidePop(); });
    }, {passive:true});

    // Click NOMENCLATURE to show popover
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('a.nom-link[data-id]');
      if (a){
        e.preventDefault();
        const id = Number(a.dataset.id);
        const row = rowsById.get(id);
        if (row) showPop(a,row);
        return;
      }
      if (pop.style.display === 'block' && !pop.contains(e.target)) hidePop();
    });
    document.addEventListener('keydown', e=>{ if (e.key === 'Escape') hidePop(); });

    function render(force){
      if (!filtered.length){
        cont.innerHTML = '<div class="nores">No parts found.</div>';
        return;
      }
      const NOM_W = computeAndSetColWidths.NOM_W;
      const PN_W  = computeAndSetColWidths.PN_W;

      const viewH = cont.clientHeight;
      const st = cont.scrollTop;
      const start = Math.max(0, Math.floor(st/ROW_H) - BUFFER);
      const end   = Math.min(filtered.length, Math.ceil((st+viewH)/ROW_H) + BUFFER);
      if (!force && start===lastStart && end===lastEnd) return;
      lastStart = start; lastEnd = end;

      const totalH = filtered.length * ROW_H;
      const offsetY = start * ROW_H;

      let html = `<div class="spacer" style="height:${totalH}px;"></div>`;
      html += `<div class="tbody" style="transform:translateY(${offsetY}px)">
        <table id="bodyTable">
          <colgroup>
            <col style="width:${NOM_W}px">
            <col style="width:${PN_W}px">
          </colgroup>
          <tbody>`;

      for (let i=start;i<end;i++){
        const r = filtered[i];
        const jsf = (r['JSF PART NUMBER']||'').toString().trim();
        const mfr = (r['MFR PART NUMBER']||'').toString().trim();
        const nom = r['NOMENCLATURE'] ?? '';
        const zebraClass = (i % 2 === 0) ? 'row-a' : 'row-b';

        html += `<tr class="${zebraClass}">`;

        // NOMENCLATURE (clickable)
        html += `<td class="nom" title="${escapeAttr(String(nom))}">
                  <a href="#" class="nom-link" data-id="${r._id}">
                    <div class="nom-wrap">${escapeHTML(String(nom))}</div>
                  </a>
                 </td>`;

        // PART NUMBER (never wrap)
        html += `<td title="${escapeAttr(`JSF: ${jsf} | MFR: ${mfr}`)}">
                  <div class="pn">
                    <div class="tag">JSF:</div><div class="val">${escapeHTML(jsf)}</div>
                    <div class="tag">MFR:</div><div class="val">${escapeHTML(mfr)}</div>
                  </div>
                 </td>`;

        html += '</tr>';
      }
      html += `</tbody></table></div>`;
      cont.innerHTML = html;

      hdrTable.style.transform = 'translateX(0px)';
    }

    // Popover: SMR + EEL + TURN-IN + SERIAL
    function showPop(anchor,row){
      pop.innerHTML = `
        <button class="x" aria-label="Close" onclick="(${hidePop.toString()})()">×</button>
        <h4>Details</h4>
        ${HIDDEN_KEYS.map(k=>`
          <div class="kv"><div class="k">${k}</div><div class="v">${escapeHTML(String(row[k]??''))}</div></div>
        `).join('')}
      `;
      pop.style.display='block';

      const r = anchor.getBoundingClientRect();
      const pad=8, popW=280;
      let left = Math.min(window.innerWidth - popW - pad, r.right + pad);
      let top  = Math.max(8, r.top + window.scrollY - 4);
      const estH = 200;
      if (top + estH > window.scrollY + window.innerHeight - 8){
        top = Math.max(8, window.scrollY + window.innerHeight - estH - 8);
      }
      pop.style.width = popW+'px';
      pop.style.left  = left+'px';
      pop.style.top   = top  +'px';
    }
    function hidePop(){ pop.style.display='none'; }

    // Utils
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
    function escapeHTML(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function escapeAttr(s){ return escapeHTML(s).replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/\n/g,' '); }
    function fmt(n){ return (n??0).toLocaleString(); }
  </script>
</body>
</html>
