<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Parts Catalog</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#f5f5f5;color:#333;overflow:hidden}
  .header{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.15);z-index:100}
  h1{font-size:24px;margin-bottom:16px;font-weight:600}
  .search-box{width:100%;padding:12px 16px;border:none;border-radius:8px;font-size:16px;margin-bottom:12px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}
  .search-box:focus{outline:none;box-shadow:0 4px 8px rgba(0,0,0,.15)}
  .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .filter-btn{padding:8px 16px;border:2px solid rgba(255,255,255,.5);border-radius:20px;background:transparent;color:#fff;font-size:14px;cursor:pointer;transition:.2s;font-weight:500}
  .filter-btn.active{background:#fff;color:#667eea;border-color:#fff}
  .stats{font-size:13px;opacity:.9;margin-top:8px}
  .table-wrapper{position:fixed;top:240px;left:0;right:0;bottom:0;background:#fff;overflow:hidden}
  .table-header{position:sticky;top:0;background:#f8f9fa;z-index:10;border-bottom:2px solid #dee2e6}
  .table-header table,.table-content table{width:100%;border-collapse:collapse;table-layout:fixed}
  .table-header th{padding:12px 8px;text-align:left;font-weight:600;white-space:nowrap;font-size:12px;text-transform:uppercase;color:#495057;border:none}
  .table-container{height:calc(100% - 45px);overflow:auto;position:relative}
  .table-spacer{width:100%}
  .table-content{position:absolute;top:0;left:0;right:0}
  .table-content td{padding:12px 8px;border-bottom:1px solid #e9ecef;vertical-align:top;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .table-content tr:hover{background:#f8f9fa}
  .loading,.no-results{text-align:center;padding:40px;color:#666}
  .no-results{color:#999}
  @media (max-width:768px){
    .table-header th,.table-content td{padding:8px 4px;font-size:12px}
    h1{font-size:20px}
    .filter-btn{font-size:12px;padding:6px 12px}
    .table-wrapper{top:260px}
  }
</style>
</head>
<body>
  <div class="header">
    <h1>Parts Catalog</h1>
    <input id="searchBox" class="search-box" placeholder="Search by NOMENCLATURE, JSF PART NUMBER, MFR PART NUMBER">
    <div class="filters">
      <button class="filter-btn" data-filter="EEL">EEL: Yes</button>
      <button class="filter-btn" data-filter="SERIAL">SERIAL: Yes</button>
      <button class="filter-btn" data-filter="TURN-IN">TURN-IN: Yes</button>
    </div>
    <div id="stats" class="stats">Loading data...</div>
  </div>

  <div class="table-wrapper">
    <div class="table-header">
      <table>
        <colgroup id="colgroupHeader"></colgroup>
        <thead><tr id="headerRow"></tr></thead>
      </table>
    </div>
    <div id="tableContainer" class="table-container">
      <div class="loading">Loading parts catalog...</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    // Config
    const CSV_URL = 'https://raw.githubusercontent.com/sailalis/catalog/refs/heads/main/datatest.csv';
    const COLUMNS = [
      { label: 'NOMENCLATURE',    key: 'NOMENCLATURE' },
      { label: 'JSF PART NUMBER', key: 'JSF PART NUMBER' },
      { label: 'MFR PART NUMBER', key: 'MFR PART NUMBER' },
      { label: 'SMR',             key: 'SMR' },
      { label: 'EEL',             key: 'EEL' },
      { label: 'TURN-IN',         key: 'TURN-IN' },
      { label: 'SERIAL',          key: 'SERIAL' },
    ];
    const COL_PCTS = [34,16,16,8,6,10,10]; // sum=100
    const ROW_HEIGHT = 45, BUFFER_SIZE = 12, SEARCH_DEBOUNCE_MS = 100;

    // State
    let allData = [];
    let filteredData = [];
    let lastStart = -1, lastEnd = -1;

    // DOM
    const searchBox = document.getElementById('searchBox');
    const tableContainer = document.getElementById('tableContainer');
    const headerRow = document.getElementById('headerRow');
    const colgroupHeader = document.getElementById('colgroupHeader');
    const stats = document.getElementById('stats');

    // Header + colgroup
    colgroupHeader.innerHTML = COL_PCTS.map(p=>`<col style="width:${p}%">`).join('');
    headerRow.innerHTML = COLUMNS.map(c=>`<th>${c.label}</th>`).join('');

    // CSV load
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: ({ data }) => {
        // Build lowercase index once for search speed
        allData = data.map(r => ({
          ...r,
          _needle: [
            r['NOMENCLATURE']||'',
            r['JSF PART NUMBER']||'',
            r['MFR PART NUMBER']||'',
          ].join(' ').toLowerCase()
        }));
        filteredData = allData;
        stats.textContent = `Showing ${fmt(filteredData.length)} of ${fmt(allData.length)} parts`;
        tableContainer.innerHTML = '';
        render(true);
      },
      error: () => tableContainer.innerHTML = '<div class="no-results">Error loading catalog.</div>'
    });

    // Filters
    const activeFilters = new Set();
    document.querySelectorAll('.filter-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const k = btn.dataset.filter;
        if (activeFilters.has(k)) { activeFilters.delete(k); btn.classList.remove('active'); }
        else { activeFilters.add(k); btn.classList.add('active'); }
        runFilter();
      });
    });

    // Search (debounced)
    searchBox.addEventListener('input', debounce(runFilter, SEARCH_DEBOUNCE_MS));

    function runFilter(){
      const q = searchBox.value.trim().toLowerCase();
      if (!q && activeFilters.size===0) {
        filteredData = allData;
      } else {
        filteredData = allData.filter(row => {
          if (q && !row._needle.includes(q)) return false;
          for (const f of activeFilters) {
            const v = (row[f] || '').toString().toLowerCase();
            if (v !== 'yes') return false;
          }
          return true;
        });
      }
      tableContainer.scrollTop = 0;
      lastStart = -1; lastEnd = -1;
      stats.textContent = `Showing ${fmt(filteredData.length)} of ${fmt(allData.length)} parts`;
      render(true);
    }

    // Virtual scroll
    tableContainer.addEventListener('scroll', ()=>requestAnimationFrame(()=>render(false)), { passive:true });
    window.addEventListener('resize', ()=>render(false));

    function render(force){
      if (!filteredData.length) {
        tableContainer.innerHTML = '<div class="no-results">No parts found.</div>';
        return;
      }
      const viewH = tableContainer.clientHeight;
      const scrollTop = tableContainer.scrollTop;
      const start = Math.max(0, Math.floor(scrollTop/ROW_HEIGHT) - BUFFER_SIZE);
      const end   = Math.min(filteredData.length, Math.ceil((scrollTop+viewH)/ROW_HEIGHT) + BUFFER_SIZE);
      if (!force && start===lastStart && end===lastEnd) return;
      lastStart = start; lastEnd = end;

      const totalH = filteredData.length * ROW_HEIGHT;
      const offsetY = start * ROW_HEIGHT;

      let html = `<div class="table-spacer" style="height:${totalH}px;"></div>`;
      html += `<div class="table-content" style="transform:translateY(${offsetY}px)">
        <table>
          <colgroup>${COL_PCTS.map(p=>`<col style="width:${p}%">`).join('')}</colgroup>
          <tbody>`;
      for (let i=start;i<end;i++){
        const row = filteredData[i];
        html += '<tr>';
        for (const c of COLUMNS){
          const v = row[c.key] ?? '';
          html += `<td title="${escapeAttr(String(v))}">${escapeHTML(String(v))}</td>`;
        }
        html += '</tr>';
      }
      html += `</tbody></table></div>`;
      tableContainer.innerHTML = html;
    }

    // Utils
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
    function escapeHTML(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    function escapeAttr(s){ return escapeHTML(s).replace(/\n/g,' '); }
    function fmt(n){ return (n??0).toLocaleString(); }
  </script>
</body>
</html>
