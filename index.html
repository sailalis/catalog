<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Parts Catalog</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#f5f5f5;color:#333;overflow:hidden}
  .header{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.15);z-index:100}
  h1{font-size:24px;margin-bottom:16px;font-weight:600}
  .search-box{width:100%;padding:12px 16px;border:none;border-radius:8px;font-size:16px;margin-bottom:12px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}
  .search-box:focus{outline:none;box-shadow:0 4px 8px rgba(0,0,0,.15)}
  .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .filter-btn{padding:8px 16px;border:2px solid rgba(255,255,255,.5);border-radius:20px;background:transparent;color:#fff;font-size:14px;cursor:pointer;transition:.2s;font-weight:500}
  .filter-btn.active{background:#fff;color:#667eea;border-color:#fff}
  .stats{font-size:13px;opacity:.9;margin-top:8px}
  .table-wrapper{position:fixed;top:240px;left:0;right:0;bottom:0;background:#fff;overflow:hidden}
  .table-header{position:sticky;top:0;background:#f8f9fa;z-index:10;border-bottom:2px solid #dee2e6}
  .table-header table{width:100%;border-collapse:collapse}
  .table-header th{padding:12px 8px;text-align:left;font-weight:600;white-space:nowrap;font-size:12px;text-transform:uppercase;color:#495057;border:none}
  .table-container{height:calc(100% - 45px);overflow:auto;position:relative}
  .table-spacer{width:100%}
  .table-content{position:absolute;top:0;left:0;right:0}
  .table-content table{width:100%;border-collapse:collapse;font-size:14px}
  .table-content td{padding:12px 8px;border-bottom:1px solid #e9ecef;vertical-align:top}
  .table-content tr:hover{background:#f8f9fa}
  .loading,.no-results{text-align:center;padding:40px;color:#666}
  .no-results{color:#999}
  @media (max-width:768px){
    .table-header th,.table-content td{padding:8px 4px;font-size:12px}
    h1{font-size:20px}
    .filter-btn{font-size:12px;padding:6px 12px}
    .table-wrapper{top:260px}
  }
</style>
</head>
<body>
  <div class="header">
    <h1>Parts Catalog</h1>
    <input type="text" class="search-box" id="searchBox" placeholder="Search part numbers or nomenclature...">
    <div class="filters">
      <button class="filter-btn" data-filter="EEL">EEL: Yes</button>
      <button class="filter-btn" data-filter="SERIALIZED">Serialized: Yes</button>
      <button class="filter-btn" data-filter="TURN-IN">Turn-in: Yes</button>
    </div>
    <div class="stats" id="stats">Loading data...</div>
  </div>

  <div class="table-wrapper">
    <div class="table-header">
      <table><thead><tr id="headerRow"></tr></thead></table>
    </div>
    <div class="table-container" id="tableContainer">
      <div class="loading">Loading parts catalog...</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    // State
    let allData = [];
    let filteredData = [];
    let columns = [];                 // exact CSV header titles, preserved order
    const activeFilters = new Set();

    // Performance knobs
    const ROW_HEIGHT = 45;
    const BUFFER_SIZE = 12;
    const SEARCH_DEBOUNCE_MS = 120;

    // Cached UI refs
    const searchBox = document.getElementById('searchBox');
    const tableContainer = document.getElementById('tableContainer');
    const headerRow = document.getElementById('headerRow');
    const stats = document.getElementById('stats');

    // Derived/cache for fast search
    // Each row gets _needle: concatenated lowercase search string of key fields
    const NEEDLE_FIELDS_FALLBACK = ['JSF PART NUMBER','MFR PART NUMBER','NOMENCLATURE'];

    // Track last rendered window to avoid redundant DOM work while scrolling
    let lastStartIndex = -1, lastEndIndex = -1;

    // Debounce helper
    const debounce = (fn, ms) => {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(null, args), ms);
      };
    };

    // Load CSV
    Papa.parse('https://raw.githubusercontent.com/sailalis/catalog/refs/heads/main/datatest.csv', {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: ({ data, meta }) => {
        columns = (meta && meta.fields) ? meta.fields.slice() : [];
        // Render header exactly in CSV order
        renderHeader(columns);

        // Build search needles
        const needleFields = pickNeedleFields(columns);
        allData = data.map(row => {
          const needle = needleFields.map(f => (row[f] || '')).join(' ').toLowerCase();
          return { ...row, _needle: needle };
        });

        filteredData = allData;
        updateStats();
        // Initial render
        tableContainer.innerHTML = '';
        renderVirtualTable(true);
      },
      error: () => {
        tableContainer.innerHTML = '<div class="no-results">Error loading catalog.</div>';
      }
    });

    function pickNeedleFields(cols){
      // Use CSV columns if available; otherwise fall back
      const set = new Set(cols);
      const preferred = NEEDLE_FIELDS_FALLBACK.filter(f => set.has(f));
      // If CSV has fewer known names, include first 3 columns as a generic fallback
      if (preferred.length === 0) return cols.slice(0,3);
      return preferred;
    }

    function renderHeader(cols){
      // Only render the seven known columns if present, and in CSV order
      const wanted = new Set(['JSF PART NUMBER','MFR PART NUMBER','NOMENCLATURE','SMR CODE','EEL','SERIALIZED','TURN-IN']);
      const finalCols = cols.filter(c => wanted.has(c));
      columns = finalCols.length ? finalCols : cols; // if CSV lacks some, show all
      headerRow.innerHTML = columns.map(c => `<th>${escapeHTML(c)}</th>`).join('');
    }

    // Search + filters
    const runFilter = () => {
      const q = searchBox.value.trim().toLowerCase();
      if (!q && activeFilters.size === 0) {
        filteredData = allData;
      } else {
        filteredData = allData.filter(row => {
          if (q && !row._needle.includes(q)) return false;
          for (const filter of activeFilters) {
            const v = (row[filter] || '').toString().toLowerCase();
            if (v !== 'yes') return false;
          }
          return true;
        });
      }
      // Reset scroll + window
      tableContainer.scrollTop = 0;
      lastStartIndex = -1; lastEndIndex = -1;
      updateStats();
      renderVirtualTable(true);
    };

    const debouncedFilter = debounce(runFilter, SEARCH_DEBOUNCE_MS);

    searchBox.addEventListener('input', debouncedFilter);

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.dataset.filter;
        if (activeFilters.has(key)) {
          activeFilters.delete(key);
          btn.classList.remove('active');
        } else {
          activeFilters.add(key);
          btn.classList.add('active');
        }
        runFilter(); // immediate for filters
      });
    });

    // Virtual scrolling
    tableContainer.addEventListener('scroll', () => {
      requestAnimationFrame(() => renderVirtualTable(false));
    }, { passive: true });

    window.addEventListener('resize', () => renderVirtualTable(false));

    function renderVirtualTable(force){
      if (!filteredData || filteredData.length === 0) {
        tableContainer.innerHTML = '<div class="no-results">No parts found matching your criteria.</div>';
        return;
      }
      const viewH = tableContainer.clientHeight;
      const scrollTop = tableContainer.scrollTop;

      const startIndex = Math.max(0, Math.floor(scrollTop / ROW_HEIGHT) - BUFFER_SIZE);
      const endIndex = Math.min(filteredData.length, Math.ceil((scrollTop + viewH) / ROW_HEIGHT) + BUFFER_SIZE);

      if (!force && startIndex === lastStartIndex && endIndex === lastEndIndex) return;
      lastStartIndex = startIndex; lastEndIndex = endIndex;

      const totalHeight = filteredData.length * ROW_HEIGHT;
      const offsetY = startIndex * ROW_HEIGHT;

      let html = `<div class="table-spacer" style="height:${totalHeight}px;"></div>`;
      html += `<div class="table-content" style="transform:translateY(${offsetY}px)"><table><tbody>`;

      // Build only visible rows
      for (let i = startIndex; i < endIndex; i++) {
        const row = filteredData[i];
        html += '<tr>';
        for (const col of columns) {
          const v = row[col] ?? '';
          html += `<td>${escapeHTML(String(v))}</td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table></div>';

      tableContainer.innerHTML = html;
    }

    function updateStats(){
      stats.textContent = `Showing ${numberFmt(filteredData.length)} of ${numberFmt(allData.length)} parts`;
    }

    // Utils
    function numberFmt(n){ return (n ?? 0).toLocaleString(); }
    function escapeHTML(s){
      return s
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
  </script>
</body>
</html>
